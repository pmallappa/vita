;;; ox-awesomecv-extensions.el --- Extensions for ox-awesomecv -*- lexical-binding: t; -*-

;; This file extends ox-awesomecv with support for additional CV_ENV types
;; that are specific to the pawesome-cv class

(require 'ox-awesomecv)

;; Advise the cventry formatting function to handle additional entry types
(defun org-awesomecv--format-cventry-extended (headline contents info)
  "Extended format for HEADLINE supporting additional entry types.
CONTENTS holds the contents of the headline.  INFO is a plist used
as a communication channel."
  (let* ((entrytype
          (cl-find-if (lambda (s) (or (string-prefix-p "cv" s)
                                      (string-prefix-p "letter" s)))
                      (cons (org-element-property :CV_ENV headline)
                            (org-export-get-tags headline info))))
         (title (org-export-data (org-element-property :title headline) info))
         (date (org-element-property :DATE headline))
         (from-date (or (org-element-property :FROM headline) date))
         (to-date (or (org-element-property :TO headline) date))
         (employer (or (org-element-property :ORGANIZATION headline)
                       (org-element-property :SCHOOL headline)
                       (org-element-property :EMPLOYER headline)
                       (org-element-property :EVENT headline)
                       (org-element-property :PROJECT headline)
                       (org-element-property :POSITION headline) ""))
         (location (or (org-element-property :LOCATION headline) ""))
         (right-img (org-element-property :RIGHT_IMG headline)))
    
    (cond
     ;; Handle cvproject - maps to \projectsubentry LaTeX command
     ((string= entrytype "cvproject")
      (let* ((url (org-element-property :URL headline))
             (link-prop (org-element-property :LINK headline))
             (project-link (or url link-prop))
             ;; Extract plain text title without hyperlink
             (plain-title (org-element-interpret-data (org-element-property :title headline)))
             ;; Get all properties for flexible margin notes
             (all-props (org-element-property :PROPERTIES headline))
             ;; Define custom margin note properties (order matters)
             (margin-props '(("LINK" . "Link")
                           ("LANGUAGES" . "Languages")
                           ("TOOLS" . "Tools")
                           ("TECH" . "Tech")
                           ("STACK" . "Stack")
                           ("ARCH" . "Architecture")
                           ("OS" . "OS")
                           ("KEYWORDS" . "Keywords")
                           ("PLATFORM" . "Platform")
                           ("FRAMEWORK" . "Framework")))
             (marginnote 
              (let ((note-lines
                     (delq nil  ; Remove nil entries
                           (mapcar
                            (lambda (prop-pair)
                              (let* ((prop-key (intern (concat ":" (car prop-pair))))
                                     (prop-label (cdr prop-pair))
                                     (prop-value (org-element-property prop-key headline)))
                                (cond
                                 ;; Special handling for LINK/URL
                                 ((and (string= (car prop-pair) "LINK") project-link)
                                  (format "\\marginnotelabel{%s:} \\marginnotevalue{\\href{%s}{Project}}"
                                          prop-label project-link))
                                 ;; Regular properties
                                 ((and prop-value (not (string= (car prop-pair) "LINK")))
                                  (format "\\marginnotelabel{%s:} \\marginnotevalue{%s}"
                                          prop-label prop-value))
                                 ;; Return nil if property doesn't exist
                                 (t nil))))
                            margin-props))))
                (mapconcat 'identity note-lines "\\\\[0.2mm]\n")))
        (format "\n\\projectsubentry\n{%s}\n{%s}\n{%s}\n{%s}\n"
                plain-title
                (org-cv-utils--format-time-window from-date to-date)
                contents
                (if (string-empty-p marginnote) "" marginnote))))
     
     ;; Handle cvopensource - maps to \opensourcesubentry LaTeX command
     ((string= entrytype "cvopensource")
      (let* ((url (org-element-property :URL headline))
             (link-prop (org-element-property :LINK headline))
             (project-link (or url link-prop))
             ;; Extract plain text title without hyperlink
             (plain-title (org-element-interpret-data (org-element-property :title headline)))
             ;; Get all properties for flexible margin notes
             (all-props (org-element-property :PROPERTIES headline))
             ;; Define custom margin note properties (order matters)
             (margin-props '(("LINK" . "Link")
                           ("LANGUAGES" . "Languages")
                           ("TOOLS" . "Tools")
                           ("TECH" . "Tech")
                           ("STACK" . "Stack")
                           ("ARCH" . "Architecture")
                           ("OS" . "OS")
                           ("KEYWORDS" . "Keywords")
                           ("PLATFORM" . "Platform")
                           ("FRAMEWORK" . "Framework")))
             (marginnote 
              (let ((note-lines
                     (delq nil  ; Remove nil entries
                           (mapcar
                            (lambda (prop-pair)
                              (let* ((prop-key (intern (concat ":" (car prop-pair))))
                                     (prop-label (cdr prop-pair))
                                     (prop-value (org-element-property prop-key headline)))
                                (cond
                                 ;; Special handling for LINK/URL
                                 ((and (string= (car prop-pair) "LINK") project-link)
                                  (format "\\marginnotelabel{%s:} \\marginnotevalue{\\href{%s}{Project}}"
                                          prop-label project-link))
                                 ;; Regular properties
                                 ((and prop-value (not (string= (car prop-pair) "LINK")))
                                  (format "\\marginnotelabel{%s:} \\marginnotevalue{%s}"
                                          prop-label prop-value))
                                 ;; Return nil if property doesn't exist
                                 (t nil))))
                            margin-props))))
                (mapconcat 'identity note-lines "\\\\[0.2mm]\n")))
        (format "\n\\opensourcesubentry\n{%s}\n{%s}\n{%s}\n{%s}\n"
                plain-title
                (org-cv-utils--format-time-window from-date to-date)
                contents
                (if (string-empty-p marginnote) "" marginnote))))
     
     ;; Handle cventryshort - maps to \shortstintentry LaTeX command
     ((string= entrytype "cventryshort")
      (format "\n\\shortstintentry\n{%s}\n{%s}\n{%s}\n{%s}\n{%s}\n"
              employer
              location
              title
              (org-cv-utils--format-time-window from-date to-date)
              contents))
     
     ;; Handle cvsubsection - maps to \cvsubsection LaTeX command
     ((string= entrytype "cvsubsection")
      (format "\n\\cvsubsection{%s}\n%s\n"
              title
              contents))
     
     ;; Handle cvrole - maps to \cvrole LaTeX command
     ((string= entrytype "cvrole")
      (format "\n\\cvrole{%s}\n%s\n"
              title
              contents))
     
     ;; For all other types, fall back to original function
     (t nil))))

;; Add advice to the original formatting function
(defun org-awesomecv--format-cventry-with-extensions (orig-fun headline contents info)
  "Wrapper to add extension support to cventry formatting."
  (or (org-awesomecv--format-cventry-extended headline contents info)
      (funcall orig-fun headline contents info)))

(advice-add 'org-awesomecv--format-cventry :around #'org-awesomecv--format-cventry-with-extensions)

;; Extend headline handling to recognize new entry types
(defun org-awesomecv-headline-extended (headline contents info)
  "Extended transcode HEADLINE element into awesomecv code.
CONTENTS is the contents of the headline.  INFO is a plist used
as a communication channel."
  (unless (org-element-property :footnote-section-p headline)
    (let ((environment (cons (org-element-property :CV_ENV headline)
                             (org-export-get-tags headline info)))
          (pagebreak (org-string-nw-p (org-element-property :PAGEBREAK headline))))
      (concat
       (when pagebreak "\\clearpage\n")
       (cond
        ;; is a cv entry or subentry (including our extensions)
        ((seq-intersection environment  '("cventry"
                                          "cvsubentry"
                                          "cvemployer"
                                          "cvschool"
                                          "cvhonor"
                                          "cvproject"
                                          "cvopensource"
                                          "cventryshort"
                                          "cvsubsection"
                                          "cvrole"
                                          "cvletter"
                                          "cvletter_notitle"
                                          "lettersection"
                                          "letterheader"))
         (org-awesomecv--format-cventry headline contents info))
        ((seq-intersection environment '("cventries" "cvhonors"))
         (org-awesomecv--format-cvenvironment
          (car (seq-intersection environment '("cventries" "cvhonors"))) headline contents info))
        ((org-export-with-backend 'latex headline contents info))))))))

;; Override the headline function
(advice-add 'org-awesomecv-headline :override #'org-awesomecv-headline-extended)

(provide 'ox-awesomecv-extensions)
;;; ox-awesomecv-extensions.el ends here
