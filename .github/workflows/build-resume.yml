name: Build Resume PDF

on:
  # Allow manual trigger from Actions tab
  workflow_dispatch:
  
  # Run automatically every Monday at 9 AM UTC
  schedule:
    - cron: '0 9 * * 1'
  
  # Run on push to main branch
  push:
    branches:
      - main
    paths:
      - 'org/**'
      - 'assets/**'
      - 'Makefile'
      - '.github/workflows/build-resume.yml'

jobs:
  build-resume:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build resume builder image
        run: |
          docker build -t resume-builder -f .devcontainer/Containerfile .
      
      - name: Build Resume PDF
        run: |
          docker run --rm \
            -v "$PWD:/workspace" \
            -w /workspace \
            resume-builder make vita
      
      - name: Upload Resume PDF as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: resume-pdf-${{ github.run_number }}
          path: outputs/prem-mallappa-vita.pdf
          retention-days: 90
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: Resume Build ${{ github.run_number }}
          files: outputs/prem-mallappa-vita.pdf
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Delete old releases (keep last 5)
        uses: dev-drprasad/delete-older-releases@v0.3.2
        with:
          keep_latest: 5
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
